# 深入理解java虚拟机：java高级特性和最佳实践

参考《Java程序性能优化-让你的Java程序更快、更稳定》(葛一宁等编著)中有关虚拟机部分的例子 
## 第二章：知识点

### 一、java虚拟机运行时数据区 

#### 1.程序计数器：

- 每一个线程都需要有独立的程序计数器，用来记录当前线程下一条运行的指令。<br/>
- 如果当前线程正在执行的是java方法，那么程序计数器记录的就是java字节码地址，如果是native方法，则计数器为空。<br/>
- 此区域是唯一一个在java虚拟机规范中没有规定任何outofmemoryerror情况的区域。  

#### 2.java虚拟机栈

- 线程私有，生命周期和线程一样<br/>
- java虚拟机栈是描述java方法执行的内存模型：每个方法被执行的同时会创建一个栈帧，用来存储局部变量表，操作栈，动态链接，方法出口等，每一个方法执行的过程就对应着一个栈帧在虚拟机栈中入栈和出栈的过程<br/>
- 局部变量表可以存放java的基本数据类型和对象引用、returnAddress类型（一条字节码指令地址）。在编译期间就已经完成分配了局部变量表的空间。通过Xss进行虚拟机栈空间进行分配<br/>
- 如果线程请求的栈深度大于了虚拟机栈所允许的深度，将抛出stackoverflowerror的异常。如果虚拟机允许动态扩展，当扩展时无法申请到足够的内存就会抛出outofmemoryerror的异常。

#### 3.本地方法栈
- 和虚拟机栈类似，只不过虚拟机栈执行的是java方法（字节码）服务，而本地方法栈使用的是native方法服务。也会存在那两种异常<br/>

#### 4.java堆
- 所有线程所共享，虚拟机启动的时候创建，唯一目的是用来存放对象实例。分为新生代和老年代，新生代分为Eden空间，from survivor空间和to survivor空间<br/>
- 可通过Xms和Xmx进行控制，如果堆中没有内存进行分配对象实例就会报outofmemoryerror的异常。

#### 5.方法区
- 所有线程共享，用来存储已经被虚拟机加载的类的类型信息，常量池，域信息，方法信息。类型信息包括类的完整名称，父类的完整名称，类型修饰符（public/protected/private）和类型的直接接口类表；常量池包括这个类方法，域等信息所引用的常量信息；域信息包括域名称，域类型和域修饰符；方法信息包括方法名称，返回类型，方法参数，方法修饰符，方法字节码，操作数栈和方法帧栈的局部变量区大小以及异常表。

### 二、对象访问
#### 1.句柄访问：
- 使用句柄访问会在java堆中划分一块内存作为句柄池，reference中存储的就是对象的句柄地址，而句柄中包含了对象实例数据和类型数据的各自地址信息。
![图示](https://github.com/myismyself/book_tip_jvm/blob/master/1525444405(1).png)
#### 2.直接指针访问的方式
- reference中存储的就是对象的地址值
![图示](https://github.com/myismyself/book_tip_jvm/blob/master/1525444442(1).jpg)
### 三、实战outofmemoryerror

### 四、jvm的内存分配参数
- Xmx 设置可以分配堆的最大内存     Runtime.getRuntime().maxMemory()：用来获得系统可用的最大的堆内存。
- Xms 设置系统可用的最小堆空间，也就是系统启动时jvm所占据的系统内存大小。
![xms设置的相关影响](https://github.com/myismyself/book_tip_jvm/blob/master/Xms.jpg)
因此 将Xmx和Xms设置的相同可以减少系统初期gc的运行次数 减少对系统的初期对性能的影响。
- Xmn 设置新生代的大小，设置新生代的大较大会减小老年代的大小，参数对系统性能和gc有很大的影响 一般设置为Java堆的4/1到3/1。hot spot虚拟机中XX:NewSize表示设置新生代的初始大小 ，XX:MaxNewSize表示设置新生代的最大值 这两个值设置的不一样也会影响系统的开销。通常情况下 设置Xmn就能满足需求
- 在hot spot虚拟机中 XX:PermSize设置方法区的初始大小，XX:MaxPermSize设置方法去的最大值。方法区的大小决定了系统可以定义多少个类和多少常量。
- Xss用来设置虚拟机栈的大小（为每个线程执行方法时开辟的空间大小）。 函数运行时，都需要在栈中开辟空间，如果栈分配的空间太小，那么线程运行时就没有足够的空间来分配局部变量，或者打不到足够函数调用的深度，导致程序异常退出，如果太大，那么开设线程的内存成本就会上升，支持的线程数就会减小。
- -XX:SurvivorRatio用来设置新生代中eden空间和from空间的比例关系，注意from空间和to空间的大小是相同的。因此加入设置Xmn大小为10 而SurvivorRatio的比例为2那么eden空间的大小为10/(2+1+1)*2=5。
- -XX:NewRatio，可以设置老年代和新生代的比例。
- 设置的参数一览表

## 第三章：垃圾回收器和内存分配策略
